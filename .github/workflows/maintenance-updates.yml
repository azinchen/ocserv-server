name: Maintenance - Automated Updates

permissions:
  contents: write
  pull-requests: write

on:
  schedule:
    # Run at 3 AM UTC daily to stagger the updates
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - packages
          - apk
          - alpine
      force_update:
        description: 'Force update MD files even if content unchanged'
        required: false
        default: false
        type: boolean

jobs:
  update-apk-packages:
    name: üì¶ Update APK Packages
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'apk' || github.event.inputs.update_type == '' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Update APK package versions
        id: update-apk
        run: |
          chmod +x ./scripts/update-apk-versions.sh
          ./scripts/update-apk-versions.sh Dockerfile

          UPDATE_DATE=$(date +%y%m%d)
          echo "update_date=${UPDATE_DATE}" >> $GITHUB_ENV
          echo "update_date=${UPDATE_DATE}" >> $GITHUB_OUTPUT

      - name: Create Pull Request for APK updates
        uses: peter-evans/create-pull-request@v8.0.0
        with:
          branch: bot/update-apk-packages
          commit-message: "deps: update ${{ steps.update-apk.outputs.updated_count }} APK package(s) (${{ env.update_date }})"
          delete-branch: true
          title: "üì¶ Update APK packages - ${{ env.update_date }}"
          body: |
            ## üì¶ APK Package Updates
            
            **Date**: ${{ env.update_date }}
            **Packages updated**: ${{ steps.update-apk.outputs.updated_count }} of ${{ steps.update-apk.outputs.total_packages }} checked
            
            ### Updated Packages:
            ${{ steps.update-apk.outputs.packages_updated }}
            
            ### Changes:
            - Updated Alpine Linux package versions in Dockerfile
            - Maintained compatibility with existing configurations
            
            ---
            ü§ñ Auto-generated by [update-apk workflow](https://github.com/${{ github.repository }}/actions/workflows/maintenance-updates.yml)

  update-github-packages:
    name: üìã Update GitHub Package Versions
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'packages' || github.event.inputs.update_type == '' }}
    strategy:
      matrix:
        repository: ["just-containers/s6-overlay"]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Get latest version for ${{ matrix.repository }}
        id: get-version
        shell: bash
        run: |
          TAG=$(curl -Ls https://api.github.com/repos/${{ matrix.repository }}/tags | jq -r "first.name")
          PACKAGE_VERSION=${TAG:1}
          BRANCH_NAME="bot/update-$(echo '${{ matrix.repository }}' | sed 's/\//-/g')-${PACKAGE_VERSION}"

          echo "package_version=${PACKAGE_VERSION}" >> $GITHUB_ENV
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_ENV
          echo "repo_name=$(echo '${{ matrix.repository }}' | cut -d'/' -f2)" >> $GITHUB_ENV

      - name: Update Dockerfile with new version
        shell: bash
        run: |
          ESCAPED_SEARCH=$(printf '%s\n' "${{ matrix.repository }}" | sed -e 's/[\/&]/\\&/g')
          sed -i "/.*${ESCAPED_SEARCH}.*/{n;s/.*/ENV PACKAGEVERSION=\"${{ env.package_version }}\"/}" Dockerfile

      - name: Create Pull Request for ${{ matrix.repository }}
        uses: peter-evans/create-pull-request@v8.0.0
        with:
          branch: bot/${{ env.branch_name }}
          commit-message: "deps: bump ${{ env.repo_name }} to v${{ env.package_version }}"
          delete-branch: true
          title: "üìã Bump ${{ env.repo_name }} to v${{ env.package_version }}"
          body: |
            ## üìã Package Version Update
            
            **Repository**: [${{ matrix.repository }}](https://github.com/${{ matrix.repository }})
            **Version**: `${{ env.package_version }}`
            
            This PR updates the package version in the Dockerfile.
            
            ### Changes:
            - Updated `PACKAGEVERSION` environment variable
            - Bumped from previous version to `${{ env.package_version }}`
            
            ---
            ü§ñ Auto-generated by [update-packages workflow](https://github.com/${{ github.repository }}/actions/workflows/maintenance-updates.yml)

  update-ocserv-version:
    name: üîÑ Update Ocserv Version
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'packages' || github.event.inputs.update_type == '' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Get latest ocserv version
        id: get-version
        shell: bash
        run: |
          TAG=$(curl -Ls https://gitlab.com/api/v4/projects/openconnect%2Focserv/repository/tags | jq -r ".[0].name")
          OCSERV_VERSION=${TAG#v}
          BRANCH_NAME="bot/update-ocserv-version"

          echo "ocserv_version=${OCSERV_VERSION}" >> $GITHUB_OUTPUT
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

      - name: Update Dockerfile with new ocserv version
        shell: bash
        run: |
          sed -i "s/ARG OCSERV_VERSION=.*/ARG OCSERV_VERSION=${{ steps.get-version.outputs.ocserv_version }}/" Dockerfile

      - name: Create Pull Request for ocserv update
        uses: peter-evans/create-pull-request@v8.0.0
        with:
          branch: ${{ steps.get-version.outputs.branch_name }}
          commit-message: "deps: bump ocserv to v${{ steps.get-version.outputs.ocserv_version }}"
          delete-branch: true
          title: "üîÑ Bump ocserv to v${{ steps.get-version.outputs.ocserv_version }}"
          body: |
            ## üîÑ Ocserv Version Update
            
            **Repository**: [openconnect/ocserv](https://gitlab.com/openconnect/ocserv)
            **Version**: `${{ steps.get-version.outputs.ocserv_version }}`
            
            This PR updates the ocserv version in the Dockerfile.
            
            ### Changes:
            - Updated `OCSERV_VERSION` ARG in Dockerfile
            - Bumped from previous version to `${{ steps.get-version.outputs.ocserv_version }}`
            
            ---
            ü§ñ Auto-generated by [maintenance-updates workflow](https://github.com/${{ github.repository }}/actions/workflows/maintenance-updates.yml)

  update-alpine-version:
    name: üêß Update Alpine Version
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'alpine' || github.event.inputs.update_type == '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Determine latest Alpine version
        id: get-alpine
        shell: bash
        run: |
          echo "Fetching latest Alpine tags from Docker Hub..."
          # Fetch tags and select the highest semantic version (major.minor.patch)
          TAGS=$(curl -s 'https://registry.hub.docker.com/v2/repositories/library/alpine/tags?page_size=200' \
            | jq -r '.results[].name' \
            | grep -E '^[0-9]+\.[0-9]+(\.[0-9]+)?$' \
            | sed -E 's/^([0-9]+\.[0-9]+)$/\1.0/' \
            | sort -V)

          if [ -z "$TAGS" ]; then
            echo "Failed to fetch Alpine tags" >&2
            exit 1
          fi

          LATEST=$(echo "$TAGS" | tail -n1)
          echo "Latest Alpine version: $LATEST"

          # Capture current version from Dockerfile before change
          CURRENT=$(grep -E '^FROM[[:space:]]+alpine:' Dockerfile | head -n1 | sed -E 's/.*alpine:([^[:space:]]+).*/\1/')
          echo "Current Alpine version in Dockerfile: $CURRENT"

          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          DATE=$(date +%y%m%d)
          echo "update_date=${DATE}" >> $GITHUB_ENV

      - name: Update Dockerfile if newer version available
        id: update-dockerfile
        if: ${{ steps.get-alpine.outputs.latest != '' && steps.get-alpine.outputs.latest != steps.get-alpine.outputs.current }}
        shell: bash
        run: |
          LATEST='${{ steps.get-alpine.outputs.latest }}'
          echo "Updating all FROM alpine:* lines to alpine:${LATEST}..."
          # Replace every FROM alpine:<tag> with the latest version, preserving trailing parts (e.g., AS stage)
          sed -i -E "s/^(FROM[[:space:]]+alpine:)[^[:space:]]+/\1${LATEST}/g" Dockerfile
          echo "updated=true" >> $GITHUB_OUTPUT
          echo "new_version=${LATEST}" >> $GITHUB_OUTPUT

      - name: Update APK package versions
        id: update-apk
        if: steps.update-dockerfile.outputs.updated == 'true'
        shell: bash
        run: |
          echo "Updating APK package versions for new Alpine base..."
          chmod +x ./scripts/update-apk-versions.sh
          ./scripts/update-apk-versions.sh Dockerfile

      - name: Create Pull Request for Alpine bump
        if: steps.update-dockerfile.outputs.updated == 'true'
        uses: peter-evans/create-pull-request@v8.0.0
        with:
          branch: bot/update-alpine
          commit-message: "deps: bump Alpine to v${{ steps.get-alpine.outputs.latest }} (${{ env.update_date }})"
          delete-branch: true
          title: "üêß Bump Alpine to v${{ steps.get-alpine.outputs.latest }} - ${{ env.update_date }}"
          body: |
            ## üêß Alpine Base Image Update

            **File**: `Dockerfile`
            **Date**: ${{ env.update_date }}
            **Source**: Docker Hub `library/alpine` tags

            ### Change
            - Current: `${{ steps.get-alpine.outputs.current }}`
            - New: `${{ steps.get-alpine.outputs.latest }}`

            This PR updates all `FROM alpine:*` lines to the latest stable Alpine tag.

            ---
            ü§ñ Auto-generated by [update-alpine workflow](https://github.com/${{ github.repository }}/actions/workflows/maintenance-updates.yml)
